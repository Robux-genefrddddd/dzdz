rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ===== HELPER FUNCTIONS =====
    function isAuth() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isAuth() && request.auth.uid == userId;
    }

    function isAdmin() {
      return isAuth() && exists(/databases/$(database)/documents/users/$(request.auth.uid)) 
        && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.get('isAdmin', false) == true;
    }

    function isValidEmail(email) {
      return email.matches('^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\\.[a-zA-Z]{2,}$');
    }

    function rateLimitCheck(userId) {
      // Simple rate limiting: allow 1 request per second
      return request.time > resource.data.lastWrite + duration.value(1, 's') || !('lastWrite' in resource.data);
    }

    // ===== USERS COLLECTION =====
    match /users/{userId} {
      // Users can only read their own profile + basic public data
      allow read: if isAuth() && (isOwner(userId) || isAdmin());
      
      // Only account creation during auth, cannot modify isAdmin field
      allow create: if isOwner(userId) 
        && !('isAdmin' in request.resource.data)
        && !('role' in request.resource.data)
        && request.resource.data.get('plan', 'Free') == 'Free'
        && request.resource.data.get('messagesUsed', 0) == 0;
      
      // Users can only update specific fields, never isAdmin/role
      allow update: if isOwner(userId) 
        && !('isAdmin' in request.resource.data)
        && !('role' in request.resource.data)
        && !('uid' in request.resource.data)
        && !('plan' in request.resource.data);
      
      // Only admins and self can delete
      allow delete: if isOwner(userId) || isAdmin();
    }

    // ===== LICENSES COLLECTION =====
    match /licenses/{licenseId} {
      // Only admins can create/manage licenses
      allow read: if isAdmin();
      allow create, write, delete: if isAdmin() 
        && request.resource.data.get('createdBy', '') == request.auth.uid
        && request.resource.data.get('createdAt', '') != '';
    }

    // ===== CONVERSATIONS COLLECTION =====
    match /conversations/{conversationId} {
      // Users can only access their own conversations
      allow read: if isAuth() && resource.data.userId == request.auth.uid;
      
      // Users can create their own conversations
      allow create: if isAuth() 
        && request.resource.data.userId == request.auth.uid
        && request.resource.data.get('createdAt', '') != '';
      
      // Users can update only specific fields in their conversations
      allow update: if isAuth() && resource.data.userId == request.auth.uid
        && !('userId' in request.updateData)
        && !('createdAt' in request.updateData);
      
      // Users can delete their own conversations
      allow delete: if isAuth() && resource.data.userId == request.auth.uid;
    }

    // ===== MESSAGES COLLECTION =====
    match /messages/{messageId} {
      // Users can only read messages from their own conversations
      allow read: if isAuth() && exists(/databases/$(database)/documents/conversations/$(resource.data.conversationId))
        && get(/databases/$(database)/documents/conversations/$(resource.data.conversationId)).data.userId == request.auth.uid;
      
      // Users can only create messages in their conversations
      allow create: if isAuth() 
        && request.resource.data.userId == request.auth.uid
        && exists(/databases/$(database)/documents/conversations/$(request.resource.data.conversationId))
        && get(/databases/$(database)/documents/conversations/$(request.resource.data.conversationId)).data.userId == request.auth.uid
        && request.resource.data.get('createdAt', '') != '';
      
      // Users can only delete their own messages
      allow delete: if isAuth() && resource.data.userId == request.auth.uid;
      
      // No updates allowed on messages
      allow update: if false;
    }

    // ===== USER IPs COLLECTION (System Use Only) =====
    match /user_ips/{docId} {
      // Only backend service can write (via service account)
      // Users cannot read or write
      allow read, write: if false;
    }

    // ===== IP BANS COLLECTION (Admin Only) =====
    match /ip_bans/{banId} {
      allow read, write, delete: if false; // Admin operations only via backend
    }

    // ===== USER BANS COLLECTION (Admin Only) =====
    match /bans/{banId} {
      // Users can only read if they're banned
      allow read: if isAuth() && (isAdmin() || resource.data.userId == request.auth.uid);
      allow write, delete: if false; // Admin operations only via backend
    }

    // ===== MAINTENANCE NOTICES (Public Read) =====
    match /maintenance_notices/{noticeId} {
      allow read: if true; // Public read
      allow write, delete: if false; // Admin only via backend
    }

    // ===== SETTINGS (Admin Only via Backend) =====
    match /settings/{docId} {
      // Allow public read of maintenance status
      allow read: if docId == "maintenance";
      allow write: if false; // Admin only via backend
    }

    match /settings/{document=**} {
      allow read, write: if false; // Block any other settings paths
    }

    // ===== DEFAULT: DENY ALL =====
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
